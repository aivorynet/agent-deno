name: Release and Publish
on:
  push:
    tags: ['v*']
permissions:
  contents: write
  id-token: write
jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - run: deno task check
      - run: deno task test
  release:
    runs-on: ubuntu-latest
    needs: ci
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
  publish:
    runs-on: ubuntu-latest
    needs: ci
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
      - run: npm install -g npm@latest
      - name: Generate package.json for npm
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          cat > package.json << EOF
          {
            "name": "@aivorynet/monitor-agent-deno",
            "version": "$VERSION",
            "description": "AIVory Monitor agent for Deno runtime",
            "type": "module",
            "main": "src/mod.ts",
            "types": "src/mod.ts",
            "keywords": ["aivory", "monitor", "debugging", "deno"],
            "author": "AIVory",
            "license": "MIT",
            "repository": { "type": "git", "url": "https://github.com/aivorynet/agent-deno.git" },
            "homepage": "https://aivory.net/monitor/",
            "bugs": { "url": "https://github.com/aivorynet/agent-deno/issues" }
          }
          EOF
      - run: npm publish --access public --provenance
